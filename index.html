<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventário T.I - Visteon</title>
  <link rel="stylesheet" href="css/style.css" />

  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }
  </script>
</head>
<body>
  <header>
    <h1>Inventário T.I - Visteon</h1>
    <nav>
      <ul class="nav-menu">
        <li><a href="#home" class="nav-link active">Home</a></li>
        <li><a href="#consulta" class="nav-link">Consulta de Equipamentos</a></li>
        <li><a href="#cadastro" class="nav-link">Cadastramento de Equipamentos</a></li>
        <li><a href="#categorias" class="nav-link">Categorias</a></li>
        <li id="admin-link" style="display: none;"><a href="#admin" class="nav-link">Administração</a></li>
        <li><a href="#" id="logout-link" class="nav-link">Sair</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section id="home" class="page-section active">
      <h2>Bem-vindo ao Sistema de Inventário</h2>
      <div class="home-functions">
        <button id="btn-cadastrar">Cadastrar Novo Equipamento</button>
        <button id="btn-consultar">Consultar Equipamentos</button>
      </div>
    </section>

    <section id="consulta" class="page-section">
      <h2>Consulta de Equipamentos</h2>
      <label for="filter-mode">Filtrar por:</label>
      <select id="filter-mode" name="filter-mode">
        <option value="nome">Service Tag</option>
        <option value="qrCode">ID (QR Code)</option>
        <option value="dono">User</option>
        <option value="setor">Setor</option>
        <option value="hostname">Hostname</option>
      </select>
      <input type="text" id="search-equipment" placeholder="Pesquisar equipamentos..." />
      <div id="equipment-list" class="equipment-list"></div>
      <div id="equipment-details" class="equipment-details hidden"></div>
      <button id="btn-voltar-consulta" class="btn-voltar hidden">Voltar à lista</button>
    </section>

    <section id="cadastro" class="page-section">
      <h2>Cadastramento de Equipamentos</h2>
      <form id="form-cadastro" enctype="multipart/form-data">
        <label for="categoria">Categoria:</label>
        <select id="categoria" name="categoria" required></select>

        <label for="nome">Service Tag (wmic bios get serialnumber):</label>
        <input type="text" id="nome" name="nome" required />

        <label for="hostname">Hostname:</label>
        <input type="text" id="hostname" name="hostname" />

        <label for="dono">User:</label>
        <input type="text" id="dono" name="dono" required />

        <label for="setor">Setor:</label>
        <input type="text" id="setor" name="setor" required />

        <label for="descricao">Descrição:</label>
        <textarea id="descricao" name="descricao"></textarea>

        <label>Existe termo?</label>
        <div>
          <label><input type="radio" name="existeTermo" value="sim" /> Sim</label>
          <label><input type="radio" name="existeTermo" value="nao" checked /> Não</label>
        </div>

        <div id="upload-termo-container" style="display: none;">
          <label for="termo">Anexar termo (PDF):</label>
          <input type="file" id="termo" name="termo" accept=".pdf" />
        </div>

        <button type="submit">Cadastrar</button>
      </form>
    </section>

    <section id="categorias" class="page-section">
      <h2>Categorias</h2>
      <ul id="categoria-lista"></ul>
      <div id="admin-only-categorias">
        <form id="form-categoria">
          <input type="text" id="input-nova-categoria" placeholder="Adicionar nova categoria" />
          <button type="submit">Adicionar Categoria</button>
        </form>
      </div>
    </section>

    <section id="admin" class="page-section" style="display: none;">
      <h2>Administração de Usuários</h2>
      <table id="user-table" class="user-table">
        <thead>
          <tr>
            <th>Nome</th>
            <th>User</th>
            <th>Email</th>
            <th>Admin</th>
            <th>Autorizado</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="user-table-body">
          <!-- Populado via JS -->
        </tbody>
      </table>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
  <script src="js/app.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const radios = document.getElementsByName('existeTermo');
      const container = document.getElementById('upload-termo-container');

      radios.forEach(radio => {
        radio.addEventListener('change', () => {
          container.style.display = (radio.value === 'sim' && radio.checked) ? 'block' : 'none';
        });
      });

      const logoutBtn = document.getElementById('logout-link');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', e => {
          e.preventDefault();
          localStorage.removeItem('token');
          window.location.href = 'login.html';
        });
      }
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = 'login.html';
        return;
      }

      let decoded;
      try {
        decoded = jwt_decode(token);
      } catch (err) {
        localStorage.removeItem('token');
        window.location.href = 'login.html';
        return;
      }

      if (!decoded.admin) {
        // Esconder funcionalidades de admin
        document.getElementById('cadastro')?.remove();
        document.querySelector('a[href="#cadastro"]')?.remove();
        document.getElementById('form-categoria')?.remove();
      } else {
        // Mostrar aba admin
        document.getElementById('admin-link').style.display = 'inline-block';
        document.getElementById('admin').style.display = 'block';

        try {
          const res = await fetch('http://localhost:3000/admin/users', {
            headers: { Authorization: `Bearer ${token}` }
          });
          const users = await res.json();
          const tbody = document.getElementById('user-table-body');
          tbody.innerHTML = '';

          users.forEach(user => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${user.nome}</td>
              <td>${user.user}</td>
              <td>${user.email}</td>
              <td>${user.admin ? 'Sim' : 'Não'}</td>
              <td>${user.autorizado ? 'Sim' : 'Não'}</td>
              <td>
                <button class="action-btn btn-admin" onclick="toggleAdmin(${user.id})">Alternar Admin</button>
                <button class="action-btn btn-auth" onclick="toggleAutorizado(${user.id})">Alternar Autorização</button>
                <button class="action-btn btn-delete" onclick="excluirUsuario(${user.id})">Excluir</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error('Erro ao carregar usuários:', err);
        }
      }
    });

    async function toggleAdmin(id) {
      const token = localStorage.getItem('token');
      await fetch(`http://localhost:3000/admin/toggle-admin/${id}`, {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}` }
      });
      location.reload();
    }

    async function toggleAutorizado(id) {
      const token = localStorage.getItem('token');
      await fetch(`http://localhost:3000/admin/toggle-autorizado/${id}`, {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}` }
      });
      location.reload();
    }

    async function excluirUsuario(id) {
      if (!confirm('Tem certeza que deseja excluir este usuário?')) return;
      const token = localStorage.getItem('token');
      await fetch(`http://localhost:3000/admin/excluir/${id}`, {
        method: 'DELETE',
        headers: { Authorization: `Bearer ${token}` }
      });
      location.reload();
    }
  </script>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const links = document.querySelectorAll(".nav-link");
    const sections = document.querySelectorAll(".page-section");

    links.forEach(link => {
      link.addEventListener("click", e => {
        e.preventDefault();
        const target = link.getAttribute("href").substring(1);

        // Remove classe 'active' de todos os links
        links.forEach(l => l.classList.remove("active"));
        link.classList.add("active");

        // Esconde todas as seções
        sections.forEach(section => {
          section.classList.remove("active");
          section.style.display = "none";
        });

        // Mostra a seção clicada
        const targetSection = document.getElementById(target);
        if (targetSection) {
          targetSection.classList.add("active");
          targetSection.style.display = "block";
        }
      });
    });

    // Exibe apenas a seção ativa ao carregar a página
    sections.forEach(section => {
      if (!section.classList.contains("active")) {
        section.style.display = "none";
      }
    });
  });
</script>

</body>
</html>
