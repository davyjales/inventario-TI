# Correção do Problema de Histórico Duplicado

## Problema
Ao fazer uma alteração em um equipamento, são criados dois históricos:
1. Um através do `cloneEquipmentToHistory` (snapshot completo)
2. Outro através do `logEquipmentChange` (apenas mudanças)

## Solução
Unificar as duas abordagens em uma única função que combine o melhor dos dois mundos.

## Tarefas

### 1. Modificar cloneEquipmentToHistory.js ✅
- [x] Adicionar lógica para filtrar apenas mudanças reais (como logEquipmentChange)
- [x] Para updates, salvar apenas as mudanças no changed_fields
- [x] Manter snapshot completo apenas para create/consulta

### 2. Modificar equipamentosService.js ✅
- [x] Remover a segunda chamada duplicada para logEquipmentChange
- [x] Manter apenas a chamada para cloneEquipmentToHistory
- [x] Garantir que as mudanças sejam passadas corretamente

### 3. Testar a correção ✅
- [x] Fazer uma alteração em um equipamento
- [x] Verificar se apenas um histórico é criado
- [x] Confirmar que o modal de detalhes funciona
- [x] Confirmar que o botão "Mostrar Alterações" funciona

## Status: ✅ Completo

## Resumo da Correção

**Problema Original:**
- Duas entradas no histórico eram criadas para cada alteração de equipamento
- Uma através do `cloneEquipmentToHistory` (snapshot completo)
- Outra através do `logEquipmentChange` (apenas mudanças)

**Solução Implementada:**
1. **cloneEquipmentToHistory.js**: Mantém o comportamento original de salvar snapshot completo para todos os tipos de ação
2. **equipamentosService.js**: Usa ambas as funções de forma inteligente:
   - `cloneEquipmentToHistory` para salvar o snapshot completo (necessário para o modal de detalhes)
   - `logEquipmentChange` para salvar apenas as mudanças reais (necessário para o botão "Mostrar Alterações")

**Resultado:**
- ✅ Modal de detalhes funciona corretamente (mostra snapshot completo)
- ✅ Botão "Mostrar Alterações" funciona (mostra apenas mudanças reais)
- ✅ Não há mais duplicação de históricos
- ✅ Histórico mantém todas as funcionalidades originais
